<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Username Modal -->
  <div id="username-modal" class="modal">
    <div class="modal-content">
      <h2>Welcome to Chat!</h2>
      <form id="username-form">
        <input id="username-input" type="text" placeholder="Enter your username..." maxlength="20" required />
        <button type="submit">Join Chat</button>
      </form>
    </div>
  </div>

  <!-- Main Chat Interface -->
  <div id="chat-app" class="hidden">
    <header class="chat-header">
      <h1>ðŸ’¬ Real-Time Chat</h1>
      <div class="user-info">
        <span id="current-user"></span>
        <span id="user-count" class="user-count">0 users online</span>
      </div>
    </header>

    <div class="chat-container">
      <div id="messages-container">
        <ul id="messages"></ul>
        <div id="typing-indicator" class="typing-indicator hidden"></div>
      </div>
      
      <form id="chat-form">
        <input id="msg" autocomplete="off" placeholder="Type a message..." maxlength="500" />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentUsername = '';
    let typingTimer;
    let isTyping = false;

    // DOM elements
    const usernameModal = document.getElementById('username-modal');
    const usernameForm = document.getElementById('username-form');
    const usernameInput = document.getElementById('username-input');
    const chatApp = document.getElementById('chat-app');
    const currentUserSpan = document.getElementById('current-user');
    const userCountSpan = document.getElementById('user-count');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('msg');
    const messages = document.getElementById('messages');
    const typingIndicator = document.getElementById('typing-indicator');

    // Username form submission
    usernameForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const username = usernameInput.value.trim();
      if (username) {
        currentUsername = username;
        currentUserSpan.textContent = `Hello, ${username}!`;
        socket.emit('user joined', username);
        usernameModal.classList.add('hidden');
        chatApp.classList.remove('hidden');
        input.focus();
      }
    });

    // Chat form submission
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const message = input.value.trim();
      if (message) {
        socket.emit('chat message', { message });
        input.value = '';
        stopTyping();
      }
    });

    // Typing indicator
    input.addEventListener('input', function() {
      if (!isTyping) {
        isTyping = true;
        socket.emit('typing');
      }
      clearTimeout(typingTimer);
      typingTimer = setTimeout(stopTyping, 1000);
    });

    function stopTyping() {
      if (isTyping) {
        isTyping = false;
        socket.emit('stop typing');
      }
    }

    // Socket event listeners
    socket.on('chat message', function (data) {
      addMessage(data, 'message');
      scrollToBottom();
    });

    socket.on('user joined', function (data) {
      addMessage(data, 'system');
      scrollToBottom();
    });

    socket.on('user left', function (data) {
      addMessage(data, 'system');
      scrollToBottom();
    });

    socket.on('user count', function (count) {
      userCountSpan.textContent = `${count} user${count !== 1 ? 's' : ''} online`;
    });

    socket.on('typing', function (data) {
      showTypingIndicator(data.username);
    });

    socket.on('stop typing', function (data) {
      hideTypingIndicator();
    });

    // Helper functions
    function addMessage(data, type) {
      const item = document.createElement('li');
      item.className = `message ${type}`;
      
      if (type === 'message') {
        const isOwnMessage = data.username === currentUsername;
        item.classList.add(isOwnMessage ? 'own' : 'other');
        
        item.innerHTML = `
          <div class="message-header">
            <span class="username">${data.username}</span>
            <span class="timestamp">${data.timestamp}</span>
          </div>
          <div class="message-content">${escapeHtml(data.message)}</div>
        `;
      } else {
        item.innerHTML = `
          <div class="system-message">
            <span class="timestamp">${data.timestamp}</span>
            ${data.message}
          </div>
        `;
      }
      
      messages.appendChild(item);
    }

    function showTypingIndicator(username) {
      typingIndicator.textContent = `${username} is typing...`;
      typingIndicator.classList.remove('hidden');
      scrollToBottom();
    }

    function hideTypingIndicator() {
      typingIndicator.classList.add('hidden');
    }

    function scrollToBottom() {
      const container = document.getElementById('messages-container');
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Focus on username input when page loads
    usernameInput.focus();
  </script>
</body>
</html>
